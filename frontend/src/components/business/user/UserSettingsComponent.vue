/**
* @file UserSettingsComponent.vue
* @description 用户设置组件 - 业务组件，用于用户修改个人设置，不是页面组件
* @author Atom Video Team
* @date 2025-04-08
*/

<template>
  <div class="settings-container">
    <div class="settings-sidebar">
      <h2 class="sidebar-title">设置</h2>
      <n-menu :value="activeSection" @update:value="activeSection = $event" :options="menuOptions" />
    </div>

    <div class="settings-content">
      <!-- 个人资料设置 -->
      <div v-if="activeSection === 'profile'" class="settings-section">
        <h2 class="section-title">个人资料</h2>
        <p class="section-description">管理你的个人信息和公开资料</p>

        <n-form class="settings-form" @submit.prevent="saveProfileSettings">
          <n-form-item label="头像" path="avatar">
            <div class="avatar-uploader">
              <n-avatar :src="profileSettings.avatar" class="avatar-preview" size="large" round />
              <n-upload :show-file-list="false" :custom-request="uploadAvatar" accept="image/*">
                <n-button class="avatar-upload-btn" ghost>更换头像</n-button>
              </n-upload>
            </div>
          </n-form-item>

          <n-form-item label="封面图" path="coverImage">
            <div class="cover-uploader">
              <div class="cover-preview" :style="{ backgroundImage: `url(${profileSettings.coverImage})` }"></div>
              <n-upload :show-file-list="false" :custom-request="uploadCoverImage" accept="image/*">
                <n-button class="cover-upload-btn" ghost>更换封面</n-button>
              </n-upload>
            </div>
          </n-form-item>

          <n-grid :cols="2" :x-gap="12">
            <n-grid-item>
              <n-form-item label="昵称" path="nickname">
                <n-input v-model:value="profileSettings.nickname" placeholder="输入你的昵称" />
              </n-form-item>
            </n-grid-item>

            <n-grid-item>
              <n-form-item label="用户名" path="username">
                <n-input v-model:value="profileSettings.username" placeholder="输入你的用户名" disabled />
                <n-text depth="3">用户名不可更改</n-text>
              </n-form-item>
            </n-grid-item>
          </n-grid>

          <n-form-item label="个人简介" path="bio">
            <n-input v-model:value="profileSettings.bio" type="textarea" placeholder="介绍一下你自己..." :rows="4" />
            <div class="char-count">{{ profileSettings.bio.length }}/200</div>
          </n-form-item>

          <n-form-item label="社交链接">
            <div v-for="(link, index) in profileSettings.socialLinks" :key="index" class="social-link-input">
              <n-grid :cols="24" :x-gap="12">
                <n-grid-item span="8">
                  <n-select v-model:value="link.platform" :options="socialPlatformOptions" />
                </n-grid-item>
                <n-grid-item span="12">
                  <n-input v-model:value="link.url" placeholder="https://..." />
                </n-grid-item>
                <n-grid-item span="4">
                  <n-button quaternary type="error" @click="removeLink(index)">删除</n-button>
                </n-grid-item>
              </n-grid>
            </div>

            <n-button secondary @click="addLink" :disabled="profileSettings.socialLinks.length >= 5"
              class="btn-add-link">
              添加社交链接
            </n-button>
            <n-text depth="3">最多添加5个社交链接</n-text>
          </n-form-item>

          <div class="form-actions">
            <n-button @click="resetProfile">取消</n-button>
            <n-button type="primary" attr-type="submit">保存更改</n-button>
          </div>
        </n-form>
      </div>

      <!-- 帐号设置 -->
      <div v-if="activeSection === 'account'" class="settings-section">
        <h2 class="section-title">帐号设置</h2>
        <p class="section-description">更新你的邮箱地址和密码</p>

        <n-form class="settings-form" @submit.prevent="saveAccountSettings">
          <n-form-item label="邮箱地址" path="email">
            <n-input v-model:value="accountSettings.email" placeholder="你的邮箱地址" />
            <n-text depth="3">用于接收通知和重置密码</n-text>
          </n-form-item>

          <n-form-item label="当前密码" path="currentPassword">
            <n-input v-model:value="accountSettings.currentPassword" type="password" placeholder="输入当前密码"
              show-password-on="click" />
          </n-form-item>

          <n-form-item label="新密码" path="newPassword">
            <n-input v-model:value="accountSettings.newPassword" type="password" placeholder="输入新密码"
              show-password-on="click" />
            <div class="password-strength">
              <div class="strength-bar-container">
                <div class="strength-bar"
                  :style="{ width: `${passwordStrength}%`, backgroundColor: passwordStrengthColor }"></div>
              </div>
              <span class="strength-text" :style="{ color: passwordStrengthColor }">{{ passwordStrengthText }}</span>
            </div>
            <n-text depth="3">密码长度至少6位，建议包含字母、数字和特殊字符</n-text>
          </n-form-item>

          <n-form-item label="确认新密码" path="confirmPassword">
            <n-input v-model:value="accountSettings.confirmPassword" type="password" placeholder="再次输入新密码"
              show-password-on="click" />
          </n-form-item>

          <div class="form-actions">
            <n-button @click="resetAccount">取消</n-button>
            <n-button type="primary" attr-type="submit">更新密码</n-button>
          </div>
        </n-form>
      </div>

      <!-- 通知设置 -->
      <div v-if="activeSection === 'notifications'" class="settings-section">
        <h2 class="section-title">通知设置</h2>
        <p class="section-description">管理你接收的通知和提醒方式</p>

        <n-form class="settings-form" @submit.prevent="saveNotificationSettings">
          <n-card title="互动通知" class="notification-group">
            <n-space vertical size="large">
              <n-space justify="space-between" align="center">
                <div class="notification-text">
                  <div class="notification-label">点赞</div>
                  <div class="notification-description">当有人点赞你的视频或评论时通知你</div>
                </div>
                <n-switch v-model:value="notificationSettings.likes" />
              </n-space>

              <n-space justify="space-between" align="center">
                <div class="notification-text">
                  <div class="notification-label">评论</div>
                  <div class="notification-description">当有人评论你的视频时通知你</div>
                </div>
                <n-switch v-model:value="notificationSettings.comments" />
              </n-space>

              <n-space justify="space-between" align="center">
                <div class="notification-text">
                  <div class="notification-label">回复</div>
                  <div class="notification-description">当有人回复你的评论时通知你</div>
                </div>
                <n-switch v-model:value="notificationSettings.replies" />
              </n-space>

              <n-space justify="space-between" align="center">
                <div class="notification-text">
                  <div class="notification-label">关注</div>
                  <div class="notification-description">当有人关注你时通知你</div>
                </div>
                <n-switch v-model:value="notificationSettings.follows" />
              </n-space>
            </n-space>
          </n-card>

          <n-card title="系统通知" class="notification-group">
            <n-space vertical size="large">
              <n-space justify="space-between" align="center">
                <div class="notification-text">
                  <div class="notification-label">视频处理</div>
                  <div class="notification-description">当你的视频处理完成或失败时通知你</div>
                </div>
                <n-switch v-model:value="notificationSettings.videoProcessing" />
              </n-space>

              <n-space justify="space-between" align="center">
                <div class="notification-text">
                  <div class="notification-label">更新与公告</div>
                  <div class="notification-description">接收关于平台更新和重要公告的通知</div>
                </div>
                <n-switch v-model:value="notificationSettings.updates" />
              </n-space>
            </n-space>
          </n-card>

          <n-card title="通知方式" class="notification-group">
            <n-space vertical size="large">
              <n-space justify="space-between" align="center">
                <div class="notification-text">
                  <div class="notification-label">邮件通知</div>
                  <div class="notification-description">通过邮件接收通知</div>
                </div>
                <n-switch v-model:value="notificationSettings.emailNotification" />
              </n-space>

              <n-space justify="space-between" align="center">
                <div class="notification-text">
                  <div class="notification-label">浏览器通知</div>
                  <div class="notification-description">在浏览器中接收通知</div>
                </div>
                <n-switch v-model:value="notificationSettings.browserNotification" />
              </n-space>
            </n-space>
          </n-card>

          <div class="form-actions">
            <n-button @click="resetNotifications">取消</n-button>
            <n-button type="primary" attr-type="submit">保存设置</n-button>
          </div>
        </n-form>
      </div>

      <!-- 隐私设置 -->
      <div v-if="activeSection === 'privacy'" class="settings-section">
        <h2 class="section-title">隐私设置</h2>
        <p class="section-description">管理你的隐私和可见性选项</p>

        <n-form class="settings-form" @submit.prevent="savePrivacySettings">
          <n-card title="个人资料隐私" class="privacy-group">
            <n-space vertical size="large">
              <n-space justify="space-between" align="center">
                <div class="privacy-text">
                  <div class="privacy-label">显示观看历史</div>
                  <div class="privacy-description">允许其他用户查看你的观看历史</div>
                </div>
                <n-switch v-model:value="privacySettings.showWatchHistory" />
              </n-space>

              <n-space justify="space-between" align="center">
                <div class="privacy-text">
                  <div class="privacy-label">显示收藏内容</div>
                  <div class="privacy-description">允许其他用户查看你的收藏内容</div>
                </div>
                <n-switch v-model:value="privacySettings.showFavorites" />
              </n-space>

              <n-space justify="space-between" align="center">
                <div class="privacy-text">
                  <div class="privacy-label">显示关注列表</div>
                  <div class="privacy-description">允许其他用户查看你关注的用户</div>
                </div>
                <n-switch v-model:value="privacySettings.showFollowing" />
              </n-space>
            </n-space>
          </n-card>

          <n-card title="互动隐私" class="privacy-group">
            <n-space vertical size="large">
              <n-space justify="space-between" align="center">
                <div class="privacy-text">
                  <div class="privacy-label">显示点赞</div>
                  <div class="privacy-description">允许其他用户查看你点赞的内容</div>
                </div>
                <n-switch v-model:value="privacySettings.showLikes" />
              </n-space>

              <n-space justify="space-between" align="center">
                <div class="privacy-text">
                  <div class="privacy-label">评论权限</div>
                  <div class="privacy-description">选择谁可以评论你上传的视频</div>
                </div>
                <n-select v-model:value="privacySettings.commentPermission" :options="commentOptions"
                  style="width: 150px" />
              </n-space>
            </n-space>
          </n-card>

          <div class="form-actions">
            <n-button @click="resetPrivacy">取消</n-button>
            <n-button type="primary" attr-type="submit">保存设置</n-button>
          </div>
        </n-form>
      </div>

      <!-- 外观设置 -->
      <div v-if="activeSection === 'appearance'" class="settings-section">
        <h2 class="section-title">外观设置</h2>
        <p class="section-description">自定义网站的显示方式</p>

        <n-form class="settings-form">
          <div class="appearance-settings">
            <h3 class="settings-section-title">{{ $t('settings.appearance') }}</h3>

            <div class="form-group">
              <label for="theme" class="form-label">{{ $t('settings.theme') }}</label>
              <n-select id="theme" v-model:value="appearanceSettings.theme" :options="themeOptions" />
            </div>

            <div class="form-group">
              <label for="fontSize" class="form-label">{{ $t('settings.fontSize') }}</label>
              <div class="fontSize-selector">
                <span class="fontSize-label">小</span>
                <n-slider v-model:value="appearanceSettings.fontSize" :min="12" :max="20" :step="1" />
                <span class="fontSize-value">{{ appearanceSettings.fontSize }}px</span>
              </div>
            </div>

            <div class="form-group">
              <label for="language" class="form-label">{{ $t('settings.language') }}</label>
              <LanguageSelectorComponent class="settings-language-selector" />
            </div>

            <div class="settings-actions">
              <n-button @click="resetAppearance">取消</n-button>
              <n-button type="primary" @click="saveAppearanceSettings">保存设置</n-button>
            </div>
          </div>
        </n-form>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
  import { ref, reactive, onMounted, computed, h, watch } from 'vue';
  import {
    NMenu,
    NForm,
    NFormItem,
    NInput,
    NButton,
    NAvatar,
    NGrid,
    NGridItem,
    NSelect,
    NSwitch,
    NCard,
    NSpace,
    NText,
    NRadioGroup,
    NRadio,
    NSlider,
    useMessage,
    NUpload
  } from 'naive-ui';
  import LanguageSelectorComponent from '@/components/business/user/LanguageSelectorComponent.vue';
  import { useUserStore } from '@/stores/user';
  import { useAuthStore } from '@/stores/auth';
  import type { User } from '@/types';
  import { storeToRefs } from 'pinia';

  // 消息提示
  const message = useMessage();

  // 获取用户存储
  const userStore = useUserStore();
  const authStore = useAuthStore();
  const { currentUser } = storeToRefs(userStore);

  // 设置部分列表
  const sections = [
    { id: 'profile', name: '个人资料', icon: '👤' },
    { id: 'account', name: '帐号设置', icon: '🔐' },
    { id: 'notifications', name: '通知设置', icon: '🔔' },
    { id: 'privacy', name: '隐私设置', icon: '🔒' },
    { id: 'appearance', name: '外观设置', icon: '🎨' }
  ];

  // 菜单选项
  const menuOptions = computed(() =>
    sections.map(section => ({
      label: section.name,
      key: section.id,
      icon: () => h('span', { class: 'nav-icon' }, section.icon)
    }))
  );

  // 主题选项
  const themeOptions = [
    { label: '跟随系统', value: 'system' },
    { label: '亮色模式', value: 'light' },
    { label: '暗色模式', value: 'dark' }
  ];

  // 社交平台选项
  const socialPlatformOptions = [
    { label: 'GitHub', value: 'GitHub' },
    { label: 'Twitter', value: 'Twitter' },
    { label: 'LinkedIn', value: 'LinkedIn' },
    { label: 'YouTube', value: 'YouTube' },
    { label: 'Instagram', value: 'Instagram' },
    { label: '个人网站', value: 'Personal' }
  ];

  // 评论权限选项
  const commentOptions = [
    { label: '所有人', value: 'everyone' },
    { label: '已关注我的人', value: 'followers' },
    { label: '我关注的人', value: 'following' },
    { label: '禁止评论', value: 'none' }
  ];

  // 当前活动部分
  const activeSection = ref('profile');

  // 个人资料设置
  const profileSettings = reactive({
    avatar: '',
    coverImage: '',
    nickname: '',
    username: '',
    bio: '',
    socialLinks: [
      { platform: 'GitHub', url: '' },
      { platform: 'Twitter', url: '' }
    ]
  });

  // 账号设置
  const accountSettings = reactive({
    email: '',
    currentPassword: '',
    newPassword: '',
    confirmPassword: ''
  });

  // 密码强度相关
  const passwordStrength = ref(0);
  const passwordStrengthText = computed(() => {
    if (passwordStrength.value === 0) return '请输入密码';
    if (passwordStrength.value < 30) return '弱';
    if (passwordStrength.value < 60) return '中';
    return '强';
  });
  const passwordStrengthColor = computed(() => {
    if (passwordStrength.value < 30) return '#ff4d4f';
    if (passwordStrength.value < 60) return '#faad14';
    return '#52c41a';
  });

  // 计算密码强度
  function calculatePasswordStrength(password: string): number {
    if (!password) return 0;

    let strength = 0;

    // 长度检查
    if (password.length >= 8) strength += 20;
    else if (password.length >= 6) strength += 10;

    // 复杂度检查
    if (/[A-Z]/.test(password)) strength += 20; // 大写字母
    if (/[a-z]/.test(password)) strength += 10; // 小写字母
    if (/[0-9]/.test(password)) strength += 20; // 数字
    if (/[^A-Za-z0-9]/.test(password)) strength += 30; // 特殊字符

    return Math.min(100, strength);
  }

  // 监听密码变化
  watch(() => accountSettings.newPassword, (newPassword) => {
    passwordStrength.value = calculatePasswordStrength(newPassword);
  });

  // 表单验证状态
  const profileFormValid = computed(() => {
    return !!profileSettings.nickname && profileSettings.nickname.length <= 30;
  });

  const accountFormValid = computed(() => {
    if (!accountSettings.currentPassword) return false;
    if (accountSettings.newPassword !== accountSettings.confirmPassword) return false;
    if (accountSettings.newPassword && accountSettings.newPassword.length < 6) return false;
    return true;
  });

  // 通知设置
  const notificationSettings = reactive({
    likes: true,
    comments: true,
    replies: true,
    follows: true,
    videoProcessing: true,
    updates: false,
    emailNotification: true,
    browserNotification: false
  });

  // 隐私设置
  const privacySettings = reactive({
    showWatchHistory: false,
    showFavorites: true,
    showFollowing: true,
    showLikes: false,
    commentPermission: 'everyone'
  });

  // 外观设置
  const appearanceSettings = reactive({
    theme: 'system',
    fontSize: 16
  });

  // 加载用户数据到设置中
  function loadUserDataToSettings() {
    if (!currentUser.value) return;

    // 更新个人资料设置
    profileSettings.avatar = currentUser.value.avatar || 'https://i.pravatar.cc/150?u=user1';
    profileSettings.coverImage = 'https://picsum.photos/1200/300?random=1'; // 假设用户模型中没有封面图片
    profileSettings.nickname = currentUser.value.nickname || '示例用户';
    profileSettings.username = currentUser.value.username || 'example_user';
    profileSettings.bio = currentUser.value.bio || '这是个人简介，可以介绍一下你自己或者分享你感兴趣的内容。';

    // 处理社交链接
    if (currentUser.value.social) {
      profileSettings.socialLinks = [];
      if (currentUser.value.social.github) {
        profileSettings.socialLinks.push({ platform: 'GitHub', url: currentUser.value.social.github });
      }
      if (currentUser.value.social.twitter) {
        profileSettings.socialLinks.push({ platform: 'Twitter', url: currentUser.value.social.twitter });
      }
      if (currentUser.value.social.website) {
        profileSettings.socialLinks.push({ platform: 'Personal', url: currentUser.value.social.website });
      }
    }

    // 更新账号设置
    accountSettings.email = currentUser.value.email || 'user@example.com';
  }

  // 加载外观设置
  function loadAppearanceSettings() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      appearanceSettings.theme = savedTheme;
    }

    const savedFontSize = localStorage.getItem('fontSize');
    if (savedFontSize) {
      appearanceSettings.fontSize = parseInt(savedFontSize);
    }
  }

  // 保存外观设置
  async function saveAppearanceSettings() {
    try {
      // 展示加载状态
      const loadingMsg = message.loading('正在保存外观设置...', {
        duration: 0
      });

      // 模拟异步操作
      await new Promise(resolve => setTimeout(resolve, 600));

      // 保存到本地存储
      localStorage.setItem('appearanceSettings', JSON.stringify(appearanceSettings));
      localStorage.setItem('theme', appearanceSettings.theme);
      localStorage.setItem('fontSize', appearanceSettings.fontSize.toString());

      // 应用主题和字体大小
      applyTheme(appearanceSettings.theme);
      applyFontSize(appearanceSettings.fontSize);

      // 关闭加载提示
      loadingMsg.destroy();
      message.success('外观设置已保存');
    } catch (err) {
      console.error('保存外观设置时出错:', err);
      message.error('保存外观设置失败');
    }
  }

  // 从本地存储加载设置
  function loadSettingsFromLocalStorage() {
    try {
      // 尝试从localStorage加载通知设置
      const savedNotificationSettings = localStorage.getItem('notificationSettings');
      if (savedNotificationSettings) {
        Object.assign(notificationSettings, JSON.parse(savedNotificationSettings));
      }

      // 尝试从localStorage加载隐私设置
      const savedPrivacySettings = localStorage.getItem('privacySettings');
      if (savedPrivacySettings) {
        Object.assign(privacySettings, JSON.parse(savedPrivacySettings));
      }

      // 加载外观设置
      loadAppearanceSettings();
    } catch (error) {
      console.error('从本地存储加载设置时出错:', error);
    }
  }

  // 添加社交链接
  function addLink() {
    if (profileSettings.socialLinks.length < 5) {
      profileSettings.socialLinks.push({ platform: 'GitHub', url: '' });
    }
  }

  // 删除社交链接
  function removeLink(index: number) {
    profileSettings.socialLinks.splice(index, 1);
  }

  // 保存个人资料设置
  async function saveProfileSettings() {
    try {
      if (!currentUser.value) {
        message.error('请先登录');
        return;
      }

      // 表单验证
      if (!profileFormValid.value) {
        message.error('请检查表单信息是否填写正确');
        return;
      }

      // 展示加载状态
      const loadingMsg = message.loading('正在保存个人资料...', {
        duration: 0
      });

      // 构建要更新的用户资料
      const updateData: Partial<User> = {
        nickname: profileSettings.nickname,
        bio: profileSettings.bio,
        avatar: profileSettings.avatar,
        social: {
          website: profileSettings.socialLinks.find(link => link.platform === 'Personal')?.url,
          github: profileSettings.socialLinks.find(link => link.platform === 'GitHub')?.url,
          twitter: profileSettings.socialLinks.find(link => link.platform === 'Twitter')?.url,
        }
      };

      // 模拟异步操作
      await new Promise(resolve => setTimeout(resolve, 800));

      // 更新本地存储中的用户数据
      const userData = JSON.parse(localStorage.getItem('user') || '{}');
      const updatedUserData = { ...userData, ...updateData };
      localStorage.setItem('user', JSON.stringify(updatedUserData));

      // 同步到userStore
      userStore.setUser(updatedUserData);

      // 关闭加载提示
      loadingMsg.destroy();
      message.success('个人资料已更新');
    } catch (err) {
      console.error('保存个人资料时出错:', err);
      message.error('保存个人资料失败');
    }
  }

  // 重置个人资料设置
  function resetProfile() {
    loadUserDataToSettings();
    message.info('已重置个人资料设置');
  }

  // 保存账号设置
  async function saveAccountSettings() {
    // 验证密码
    if (!accountFormValid.value) {
      if (accountSettings.newPassword !== accountSettings.confirmPassword) {
        message.error('两次输入的密码不一致');
        return;
      }

      if (!accountSettings.currentPassword) {
        message.error('请输入当前密码');
        return;
      }

      if (accountSettings.newPassword.length < 6) {
        message.error('新密码长度至少为6位');
        return;
      }
    }

    try {
      // 展示加载状态
      const loadingMsg = message.loading('正在更新密码...', {
        duration: 0
      });

      // 模拟密码更新 - 实际项目中应通过API处理
      // 模拟异步操作
      await new Promise(resolve => setTimeout(resolve, 1000));

      // 关闭加载提示
      loadingMsg.destroy();
      message.success('密码已更新');

      // 清空密码字段
      accountSettings.currentPassword = '';
      accountSettings.newPassword = '';
      accountSettings.confirmPassword = '';
    } catch (err) {
      console.error('更新密码时出错:', err);
      message.error('更新密码失败');
    }
  }

  // 重置账号设置
  function resetAccount() {
    accountSettings.currentPassword = '';
    accountSettings.newPassword = '';
    accountSettings.confirmPassword = '';
    message.info('已重置密码表单');
  }

  // 保存通知设置
  async function saveNotificationSettings() {
    try {
      // 展示加载状态
      const loadingMsg = message.loading('正在保存通知设置...', {
        duration: 0
      });

      // 模拟异步操作
      await new Promise(resolve => setTimeout(resolve, 600));

      // 保存到本地存储
      localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));

      // 关闭加载提示
      loadingMsg.destroy();
      message.success('通知设置已更新');
    } catch (err) {
      console.error('保存通知设置时出错:', err);
      message.error('保存通知设置失败');
    }
  }

  // 重置通知设置
  function resetNotifications() {
    Object.assign(notificationSettings, {
      likes: true,
      comments: true,
      replies: true,
      follows: true,
      videoProcessing: true,
      updates: false,
      emailNotification: true,
      browserNotification: false
    });
    message.info('已重置通知设置');
  }

  // 保存隐私设置
  async function savePrivacySettings() {
    try {
      // 展示加载状态
      const loadingMsg = message.loading('正在保存隐私设置...', {
        duration: 0
      });

      // 模拟异步操作
      await new Promise(resolve => setTimeout(resolve, 600));

      // 保存到本地存储
      localStorage.setItem('privacySettings', JSON.stringify(privacySettings));

      // 关闭加载提示
      loadingMsg.destroy();
      message.success('隐私设置已更新');
    } catch (err) {
      console.error('保存隐私设置时出错:', err);
      message.error('保存隐私设置失败');
    }
  }

  // 重置隐私设置
  function resetPrivacy() {
    Object.assign(privacySettings, {
      showWatchHistory: false,
      showFavorites: true,
      showFollowing: true,
      showLikes: false,
      commentPermission: 'everyone'
    });
    message.info('已重置隐私设置');
  }

  // 应用主题设置
  function applyTheme(theme: string) {
    const rootElement = document.documentElement;

    if (theme === 'dark') {
      rootElement.classList.add('dark');
      rootElement.classList.remove('light');
    } else if (theme === 'light') {
      rootElement.classList.add('light');
      rootElement.classList.remove('dark');
    } else {
      // 系统设置
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (prefersDark) {
        rootElement.classList.add('dark');
        rootElement.classList.remove('light');
      } else {
        rootElement.classList.add('light');
        rootElement.classList.remove('dark');
      }
    }
  }

  // 应用字体大小设置
  function applyFontSize(size: number) {
    document.documentElement.style.setProperty('--base-font-size', `${size}px`);
  }

  // 重置外观设置
  function resetAppearance() {
    appearanceSettings.theme = 'system';
    appearanceSettings.fontSize = 16;
    message.info('已重置外观设置');
  }

  // 监听外观设置变化，实时应用
  watch(() => appearanceSettings.theme, (newTheme) => {
    applyTheme(newTheme);
  });

  watch(() => appearanceSettings.fontSize, (newSize) => {
    applyFontSize(newSize);
  });

  // 上传头像
  function uploadAvatar(options: any) {
    const file = options.file.file as File;
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      const result = e.target?.result as string;
      if (result) {
        profileSettings.avatar = result;
        message.success('头像已上传');
      }
    };
    reader.readAsDataURL(file);
  }

  // 上传封面图片
  function uploadCoverImage(options: any) {
    const file = options.file.file as File;
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      const result = e.target?.result as string;
      if (result) {
        profileSettings.coverImage = result;
        message.success('封面图片已上传');
      }
    };
    reader.readAsDataURL(file);
  }

  // 初始化
  onMounted(() => {
    // 加载设置
    loadSettingsFromLocalStorage();

    // 应用当前外观设置
    applyTheme(appearanceSettings.theme);
    applyFontSize(appearanceSettings.fontSize);

    // 如果用户已登录，加载用户数据
    if (currentUser.value) {
      loadUserDataToSettings();
    } else {
      // 从localStorage获取用户数据
      const savedUserJSON = localStorage.getItem('user');
      if (savedUserJSON) {
        try {
          const savedUser = JSON.parse(savedUserJSON);
          userStore.setUser(savedUser);
          loadUserDataToSettings();
        } catch (e) {
          console.error('解析保存的用户数据时出错:', e);
          message.error('加载用户数据失败');
        }
      } else {
        message.info('请先登录');
      }
    }
  });

  // 处理社交链接中的url类型问题
  const socialLink = computed(() => {
    return profileSettings.socialLinks.map(link => {
      return {
        platform: link.platform,
        url: link.url || ''
      };
    });
  });
</script>

<style scoped>
  :root {
    --base-font-size: 16px;
  }

  .settings-container {
    display: flex;
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px 16px;
    gap: 24px;
    font-size: var(--base-font-size);
  }

  .settings-sidebar {
    width: 250px;
    flex-shrink: 0;
  }

  .sidebar-title {
    font-size: calc(var(--base-font-size) * 1.25);
    font-weight: 600;
    margin: 0 0 24px;
    color: var(--color-text-primary);
  }

  .settings-content {
    flex: 1;
    min-width: 0;
  }

  .settings-section {
    background-color: var(--color-bg-surface);
    border-radius: 8px;
    padding: 24px;
  }

  .section-title {
    font-size: calc(var(--base-font-size) * 1.25);
    font-weight: 600;
    margin: 0 0 8px;
    color: var(--color-text-primary);
  }

  .section-description {
    font-size: calc(var(--base-font-size) * 0.875);
    color: var(--color-text-secondary);
    margin: 0 0 32px;
  }

  .settings-form {
    max-width: 700px;
  }

  .form-group {
    margin-bottom: 24px;
  }

  .form-group-half {
    width: calc(50% - 8px);
  }

  .form-row {
    display: flex;
    gap: 16px;
  }

  .form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--color-text-primary);
    font-size: inherit;
  }

  .form-input,
  .form-textarea,
  .form-select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--color-border-primary);
    border-radius: 4px;
    background-color: var(--color-bg-input);
    color: var(--color-text-primary);
    font-size: calc(var(--base-font-size) * 0.875);
    transition: border-color 0.3s;
  }

  .form-textarea {
    resize: vertical;
    min-height: 100px;
  }

  .form-input:focus,
  .form-textarea:focus,
  .form-select:focus {
    border-color: var(--color-accent-primary);
    outline: none;
  }

  .form-input:disabled {
    background-color: var(--color-bg-subtle);
    cursor: not-allowed;
  }

  .form-hint {
    font-size: calc(var(--base-font-size) * 0.75);
    color: var(--color-text-secondary);
    margin-top: 4px;
  }

  .char-count {
    font-size: calc(var(--base-font-size) * 0.75);
    color: var(--color-text-secondary);
    text-align: right;
    margin-top: 4px;
  }

  .avatar-uploader,
  .cover-uploader {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .avatar-preview {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
  }

  .cover-preview {
    width: 200px;
    height: 80px;
    border-radius: 4px;
    background-size: cover;
    background-position: center;
  }

  .avatar-upload-btn,
  .cover-upload-btn {
    padding: 8px 16px;
    background-color: transparent;
    border: 1px solid var(--color-border-primary);
    color: var(--color-text-primary);
    border-radius: 4px;
    cursor: pointer;
    font-size: calc(var(--base-font-size) * 0.875);
    transition: background-color 0.2s;
  }

  .avatar-upload-btn:hover,
  .cover-upload-btn:hover {
    background-color: var(--color-bg-subtle);
  }

  .social-link-input {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
  }

  .social-link-input .form-select {
    width: 120px;
    flex-shrink: 0;
  }

  .social-link-input .form-input {
    flex: 1;
  }

  .btn-remove-link {
    padding: 0 8px;
    background-color: transparent;
    border: 1px solid var(--color-border-primary);
    color: var(--color-text-danger);
    border-radius: 4px;
    cursor: pointer;
    font-size: calc(var(--base-font-size) * 0.875);
  }

  .btn-add-link {
    padding: 8px 16px;
    background-color: transparent;
    border: 1px solid var(--color-border-primary);
    color: var(--color-text-primary);
    border-radius: 4px;
    cursor: pointer;
    font-size: calc(var(--base-font-size) * 0.875);
    transition: background-color 0.2s;
  }

  .btn-add-link:hover {
    background-color: var(--color-bg-subtle);
  }

  .btn-add-link:disabled {
    color: var(--color-text-muted);
    cursor: not-allowed;
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 32px;
  }

  .btn-primary,
  .btn-secondary {
    padding: 10px 24px;
    border-radius: 4px;
    font-size: calc(var(--base-font-size) * 0.875);
    font-weight: 500;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .btn-primary {
    background-color: var(--color-accent-primary);
    color: white;
    border: none;
  }

  .btn-primary:hover {
    opacity: 0.9;
  }

  .btn-secondary {
    background-color: transparent;
    color: var(--color-text-primary);
    border: 1px solid var(--color-border-primary);
  }

  .btn-secondary:hover {
    background-color: var(--color-bg-subtle);
  }

  .notification-group,
  .privacy-group {
    margin-bottom: 32px;
  }

  .notification-title,
  .privacy-title {
    font-size: calc(var(--base-font-size) * 1);
    font-weight: 600;
    margin: 0 0 16px;
    color: var(--color-text-primary);
  }

  .notification-item,
  .privacy-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .notification-label,
  .privacy-label {
    font-weight: 500;
    margin-bottom: 4px;
    color: var(--color-text-primary);
  }

  .notification-description,
  .privacy-description {
    font-size: calc(var(--base-font-size) * 0.8125);
    color: var(--color-text-secondary);
  }

  /* 开关样式 */
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 46px;
    height: 24px;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--color-bg-inset);
    transition: .4s;
    border-radius: 24px;
  }

  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }

  input:checked+.toggle-slider {
    background-color: var(--color-accent-primary);
  }

  input:checked+.toggle-slider:before {
    transform: translateX(22px);
  }

  @media (max-width: 768px) {
    .settings-container {
      flex-direction: column;
    }

    .settings-sidebar {
      width: 100%;
      margin-bottom: 24px;
    }

    .form-row {
      flex-direction: column;
      gap: 24px;
    }

    .form-group-half {
      width: 100%;
    }

    .avatar-uploader,
    .cover-uploader {
      flex-direction: column;
      align-items: flex-start;
    }

    .cover-preview {
      width: 100%;
    }
  }

  .settings-language-selector {
    margin-top: 8px;
    width: 100%;
  }

  .settings-language-selector :deep(.selector-trigger) {
    width: 100%;
    justify-content: space-between;
    padding: 0.625rem 0.75rem;
    height: 38px;
  }

  /* 字体大小选择器样式 */
  .fontSize-selector {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 8px;
  }

  .fontSize-label {
    font-size: calc(var(--base-font-size) * 0.875);
    color: var(--color-text-secondary);
    width: 60px;
  }

  .fontSize-value {
    font-size: calc(var(--base-font-size) * 0.875);
    color: var(--color-text-primary);
    width: 30px;
    text-align: right;
  }

  /* 密码强度样式 */
  .password-strength {
    display: flex;
    align-items: center;
    margin-top: 8px;
    gap: 10px;
  }

  .strength-bar-container {
    flex: 1;
    height: 4px;
    background-color: #f0f0f0;
    border-radius: 2px;
    overflow: hidden;
  }

  .strength-bar {
    height: 100%;
    transition: width 0.3s ease, background-color 0.3s ease;
  }

  .strength-text {
    font-size: 12px;
    width: 30px;
    text-align: center;
  }
</style>